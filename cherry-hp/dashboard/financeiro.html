<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro - Cl√≠nica M√©dica</title>
    <link rel="stylesheet" href="../estilo.css">
    <style>
        /* --- Estilos Originais Mantidos --- */
        .finance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .trend-up { color: #2ecc71; }
        .trend-down { color: #e74c3c; }
        
        .filters-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .report-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            background: white;
        }
        
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .report-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .report-card p {
            color: #7f8c8d;
            font-size: 14px;
            flex-grow: 1;
            margin-bottom: 15px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .btn-icon {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .payment-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-badge.paid { background-color: #d4edda; color: #155724; }
        .status-badge.pending { background-color: #fff3cd; color: #856404; }
        .status-badge.overdue { background-color: #f8d7da; color: #721c24; }
        
        /* --- ESTILOS DO MODAL --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 5px;
        }

        /* Estilo para lista de relat√≥rios */
        .report-list {
            list-style: none;
            padding: 0;
        }
        .report-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .report-summary-box {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-label { font-size: 12px; color: #666; font-weight: bold; text-transform: uppercase; }
        .summary-val { font-size: 18px; font-weight: bold; }
        .text-green { color: #2ecc71; }
        .text-red { color: #e74c3c; }

        @media (max-width: 768px) {
            .finance-header, .filters-container, .stats-grid, .reports-grid {
                flex-direction: column;
                grid-template-columns: 1fr;
            }
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>CherryHP</h2>
            </div>
            
            <div class="sidebar-menu">
                <div onclick="window.location.href = 'index.html'" class="menu-item" data-page="dashboard">
                    <span>üè†</span> Dashboard
                </div>
                <div onclick="window.location.href = 'pacientes.html'" class="menu-item" data-page="pacientes">
                    <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Pacientes
                </div>
                <div onclick="window.location.href = 'consultas.html'" class="menu-item" data-page="consultas">
                    <span>üìÖ</span> Consultas
                </div>
                <div onclick="window.location.href = 'medicos.html'" class="menu-item" data-page="medicos">
                    <span>üë®‚Äç‚öïÔ∏è</span> M√©dicos
                </div>
                <div onclick="window.location.href = 'prontuarios.html'" class="menu-item" data-page="prontuarios">
                    <span>üìã</span> Prontu√°rios
                </div>
                <div onclick="window.location.href = 'financeiro.html'" class="menu-item active" data-page="financeiro">
                    <span>üí∞</span> Financeiro
                </div>
                <div onclick="window.location.href = 'configuracoes.html'" class="menu-item" data-page="configuracoes">
                    <span>‚öôÔ∏è</span> Configura√ß√µes
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1>Controle Financeiro</h1>
                <div class="user-info">
                    <div class="user-avatar">AD</div>
                    <span>Admin</span>
                    <button class="logout-btn">Sair</button>
                </div>
            </div>
            
            <div class="finance-header">
                <h2>Gest√£o Financeira</h2>
                <div class="time-filter">
                    <select id="timeRange">
                        <option value="all">Todo o per√≠odo</option>
                        <option value="today">Hoje</option>
                        <option value="month" selected>Este m√™s</option>
                        <option value="year">Este ano</option>
                    </select>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Receitas</h3>
                    <div class="stat-value" id="totalReceitas">R$ 0,00</div> 
                    <div class="stat-trend trend-up">Atualizado agora</div>
                </div>
                
                <div class="stat-card">
                    <h3>Despesas</h3>
                    <div class="stat-value" id="totalDespesas">R$ 0,00</div>
                    <div class="stat-trend trend-down">Atualizado agora</div>
                </div>
                
                <div class="stat-card">
                    <h3>Lucro L√≠quido</h3>
                    <div class="stat-value" id="totalLucro">R$ 0,00</div>
                    <div class="stat-trend" id="trendLucro">--</div>
                </div>
                
                <div class="stat-card">
                    <h3>Pendentes</h3>
                    <div class="stat-value" id="totalPendente">R$ 0,00</div>
                    <div class="stat-trend trend-down">A receber/pagar</div>
                </div>
            </div>
            
            <div class="filters-container">
                <div class="filter-group">
                    <label for="tipoFilter">Tipo</label>
                    <select id="tipoFilter">
                        <option value="">Todos</option>
                        <option value="receita">Receitas</option>
                        <option value="despesa">Despesas</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="categoriaFilter">Categoria</label>
                    <select id="categoriaFilter">
                        <option value="">Todas</option>
                        <option value="Consulta">Consultas</option>
                        <option value="Exame">Exames</option>
                        <option value="Procedimento">Procedimentos</option>
                        <option value="Material">Materiais</option>
                        <option value="Operacional">Operacional</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="">Todos</option>
                        <option value="pago">Pago</option>
                        <option value="pendente">Pendente</option>
                        <option value="atrasado">Atrasado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn" id="applyFilters">Aplicar Filtros</button>
                </div>
            </div>
            
            <div class="export-options">
                <button class="btn btn-icon" onclick="exportData('excel')">
                    üìä Exportar para Excel
                </button>
                <button class="btn btn-icon" onclick="window.print()">
                    üìÑ Exportar para PDF
                </button>
                <button class="btn btn-icon" onclick="exportData('csv')">
                    üìã Exportar para CSV
                </button>
                
                <button class="btn btn-icon" onclick="openDetailedReport()">
                    üìà Relat√≥rio Detalhado
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Transa√ß√µes Recentes</h3>
                    <button class="btn btn-primary" onclick="openNewTransaction()">Nova Transa√ß√£o</button>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descri√ß√£o</th>
                            <th>Paciente/Entidade</th>
                            <th>M√©dico</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="financeTableBody">
                        </tbody>
                </table>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Relat√≥rios Financeiros</h3>
                </div>
                
                <div class="reports-grid">
                    <div class="report-card">
                        <h4>Fluxo de Caixa</h4>
                        <p>An√°lise mensal de entradas e sa√≠das com gr√°ficos comparativos</p>
                        <button class="btn" onclick="generateReport('cashflow')">Gerar</button>
                    </div>
                    <div class="report-card">
                        <h4>Faturamento por M√©dico</h4>
                        <p>Desempenho financeiro por profissional e especialidade</p>
                        <button class="btn" onclick="generateReport('doctors')">Gerar</button>
                    </div>
                    <div class="report-card">
                        <h4>Contas a Receber</h4>
                        <p>Pagamentos pendentes e vencidos com datas de vencimento</p>
                        <button class="btn" onclick="generateReport('receivables')">Gerar</button>
                    </div>
                    <div class="report-card">
                        <h4>Despesas Detalhadas</h4>
                        <p>An√°lise de custos operacionais por categoria e fornecedor</p>
                        <button class="btn" onclick="generateReport('expenses')">Gerar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nova Transa√ß√£o</h3>
                <button class="btn btn-danger btn-sm" onclick="closeModal()">X</button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="transType" required>
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valor (R$)</label>
                        <input type="number" step="0.01" id="transValue" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="transDesc" required placeholder="Ex: Consulta Cardiologia">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Paciente / Entidade</label>
                        <input type="text" id="transEntity" required placeholder="Nome do paciente ou fornecedor">
                    </div>
                    <div class="form-group">
                        <label>M√©dico (Opcional)</label>
                        <select id="transDoctor">
                            <option value="">Selecione (Opcional)</option>
                            </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="transDate" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="transStatus">
                            <option value="pago">Pago</option>
                            <option value="pendente">Pendente</option>
                            <option value="atrasado">Atrasado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Categoria</label>
                    <select id="transCategory" required>
                        <option value="Consulta">Consulta</option>
                        <option value="Exame">Exame</option>
                        <option value="Procedimento">Procedimento</option>
                        <option value="Material">Material</option>
                        <option value="Operacional">Operacional</option>
                    </select>
                </div>

                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reportTitleDynamic">Relat√≥rio Gerado</h3>
                <button class="btn btn-danger btn-sm" onclick="closeReportModal()">X</button>
            </div>
            <div id="reportContent"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="window.print()">Imprimir</button>
                <button class="btn btn-danger" onclick="closeReportModal()">Fechar</button>
            </div>
        </div>
    </div>
    
    <script src="../script.js"></script>
    <script>
        const STORAGE_KEY = 'cherryhp_financeiro';

        // Lista de M√©dicos
        const doctorsList = [
            "Dra. Ana Souza",
            "Dr. Roberto Firmino",
            "Dra. Carla Diaz",
            "Dr. Lucas Silva",
            "Dra. Marina Ruy",
            "Dr. Carlos Mendes",
            "Dra. Julia Roberts",
            "Dr. Paulo Gustavo",
            "Dr. Marcos Mion",
            "Dra. Tat√° Werneck",
            "Dr. Fabio Porchat",
            "Dra. Ingrid Guimar√£es"
        ];

        // Dados iniciais (Seed)
        const initialData = [
            { id: 1001, data: '2023-05-15', desc: 'Consulta Cardiologia', entity: 'Jo√£o Silva', medico: 'Dra. Ana Souza', valor: 350.00, status: 'pago', tipo: 'receita', categoria: 'Consulta' },
            { id: 1002, data: '2023-05-14', desc: 'Exame Ecocardiograma', entity: 'Maria Oliveira', medico: 'Dra. Ana Souza', valor: 580.00, status: 'pendente', tipo: 'receita', categoria: 'Exame' },
            { id: 1003, data: '2023-05-10', desc: 'Consulta Pediatria', entity: 'Pedro Costa', medico: 'Dr. Carlos Mendes', valor: 280.00, status: 'atrasado', tipo: 'receita', categoria: 'Consulta' },
            { id: 1004, data: '2023-05-08', desc: 'Raio-X', entity: 'Ana Paula', medico: 'Dra. Tat√° Werneck', valor: 120.00, status: 'pago', tipo: 'receita', categoria: 'Exame' },
            { id: 1005, data: '2023-05-05', desc: 'Compra de Luvas', entity: 'Cir√∫rgica Central', medico: '', valor: 450.00, status: 'pago', tipo: 'despesa', categoria: 'Material' }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            populateDoctorsSelect();
            renderTable();
            updateStats();

            document.getElementById('applyFilters').addEventListener('click', function() {
                renderTable();
                showNotification('Filtros aplicados com sucesso!', 'info');
            });

            document.getElementById('timeRange').addEventListener('change', function() {
                renderTable();
            });

            document.getElementById('transactionForm').addEventListener('submit', handleFormSubmit);
        });

        function populateDoctorsSelect() {
            const select = document.getElementById('transDoctor');
            select.innerHTML = '<option value="">Selecione (Opcional)</option>';
            doctorsList.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc;
                option.innerText = doc;
                select.appendChild(option);
            });
        }

        function getTransactions() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) {
                saveTransactions(initialData);
                return initialData;
            }
            return JSON.parse(data);
        }

        function saveTransactions(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function renderTable() {
            let transactions = getTransactions();
            const tbody = document.getElementById('financeTableBody');
            tbody.innerHTML = '';

            const tipoFilter = document.getElementById('tipoFilter').value;
            const catFilter = document.getElementById('categoriaFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const timeFilter = document.getElementById('timeRange').value;
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            transactions = transactions.filter(t => {
                if (tipoFilter && t.tipo !== tipoFilter) return false;
                if (catFilter && t.categoria !== catFilter) return false;
                if (statusFilter && t.status !== statusFilter) return false;
                
                const tDateParts = t.data.split('-');
                const tDate = new Date(tDateParts[0], tDateParts[1] - 1, tDateParts[2]);

                if (timeFilter === 'today') {
                    if (tDate.getTime() !== today.getTime()) return false;
                } else if (timeFilter === 'month') {
                    if (tDate.getMonth() !== now.getMonth() || tDate.getFullYear() !== now.getFullYear()) {
                        return false; 
                    }
                } else if (timeFilter === 'year') {
                    if (tDate.getFullYear() !== now.getFullYear()) {
                        return false;
                    }
                }
                // 'all' n√£o filtra data
                
                return true;
            });

            transactions.sort((a, b) => new Date(b.data) - new Date(a.data));

            transactions.forEach(t => {
                const tr = document.createElement('tr');
                const valorFormatado = parseFloat(t.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const dataFormatada = formatDate(t.data);
                
                const badgeClass = { 'pago': 'paid', 'pendente': 'pending', 'atrasado': 'overdue' }[t.status] || 'pending';
                const statusLabel = { 'pago': 'Pago', 'pendente': 'Pendente', 'atrasado': 'Atrasado' }[t.status] || t.status;
                const corValor = t.tipo === 'despesa' ? '#e74c3c' : '#2ecc71'; 
                const sinal = t.tipo === 'despesa' ? '-' : '';

                tr.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${t.desc}</td>
                    <td>${t.entity}</td>
                    <td>${t.medico || '-'}</td>
                    <td style="color: ${corValor}; font-weight: bold;">${sinal} ${valorFormatado}</td>
                    <td><span class="status-badge ${badgeClass}">${statusLabel}</span></td>
                    <td class="payment-actions">
                        <button class="btn btn-sm" onclick="editTransaction(${t.id})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${t.id})">X</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateStats();
        }

        function updateStats() {
            const transactions = getTransactions();
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const timeFilter = document.getElementById('timeRange').value;
            
            const filteredTrans = transactions.filter(t => {
                const tDateParts = t.data.split('-');
                const tDate = new Date(tDateParts[0], tDateParts[1] - 1, tDateParts[2]);

                if (timeFilter === 'today') {
                    return tDate.getTime() === today.getTime();
                } else if (timeFilter === 'month') {
                    return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                } else if (timeFilter === 'year') {
                    return tDate.getFullYear() === now.getFullYear();
                }
                return true; // 'all'
            });

            let receita = 0, despesa = 0, pendente = 0;

            filteredTrans.forEach(t => {
                const val = parseFloat(t.valor);
                if (t.tipo === 'receita') {
                    receita += val;
                    if (t.status !== 'pago') pendente += val;
                } else {
                    despesa += val;
                    if (t.status !== 'pago') pendente += val;
                }
            });

            const lucro = receita - despesa;

            document.getElementById('totalReceitas').innerText = receita.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalDespesas').innerText = despesa.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalLucro').innerText = lucro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalPendente').innerText = pendente.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const trendElem = document.getElementById('trendLucro');
            trendElem.innerHTML = lucro >= 0 ? '<span class="trend-up">Lucro Positivo</span>' : '<span class="trend-down">Preju√≠zo</span>';
        }

        function openNewTransaction() {
            document.getElementById('modalTitle').innerText = 'Nova Transa√ß√£o';
            document.getElementById('transactionForm').reset();
            document.getElementById('transId').value = '';
            document.getElementById('transDate').valueAsDate = new Date();
            document.getElementById('transactionModal').style.display = 'flex';
        }

        function editTransaction(id) {
            const transactions = getTransactions();
            const t = transactions.find(item => item.id == id);
            if (t) {
                document.getElementById('modalTitle').innerText = 'Editar Transa√ß√£o';
                document.getElementById('transId').value = t.id;
                document.getElementById('transType').value = t.tipo;
                document.getElementById('transValue').value = t.valor;
                document.getElementById('transDesc').value = t.desc;
                document.getElementById('transEntity').value = t.entity;
                document.getElementById('transDate').value = t.data;
                document.getElementById('transStatus').value = t.status;
                document.getElementById('transCategory').value = t.categoria;
                document.getElementById('transDoctor').value = t.medico || "";
                document.getElementById('transactionModal').style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('transId').value;
            let transactions = getTransactions();

            const newData = {
                id: id ? parseInt(id) : Date.now(),
                tipo: document.getElementById('transType').value,
                valor: parseFloat(document.getElementById('transValue').value),
                desc: document.getElementById('transDesc').value,
                entity: document.getElementById('transEntity').value,
                medico: document.getElementById('transDoctor').value,
                data: document.getElementById('transDate').value,
                status: document.getElementById('transStatus').value,
                categoria: document.getElementById('transCategory').value
            };

            if (id) {
                const index = transactions.findIndex(t => t.id == id);
                if (index !== -1) transactions[index] = newData;
            } else {
                transactions.push(newData);
            }

            saveTransactions(transactions);
            closeModal();
            renderTable();
            showNotification('Transa√ß√£o salva com sucesso!', 'success');
        }

        function deleteTransaction(id) {
            if (confirm('Tem certeza que deseja excluir esta transa√ß√£o?')) {
                let transactions = getTransactions();
                transactions = transactions.filter(t => t.id != id);
                saveTransactions(transactions);
                renderTable();
                showNotification('Transa√ß√£o exclu√≠da.', 'info');
            }
        }

        // --- RELAT√ìRIOS REAIS ---
        function generateReport(type) {
            const transactions = getTransactions();
            let content = '';
            const reportTitles = {
                'cashflow': 'Fluxo de Caixa (Total)',
                'doctors': 'Faturamento por M√©dico',
                'receivables': 'Contas a Receber (Pendentes)',
                'expenses': 'Despesas por Categoria'
            };
            
            // Helper de formata√ß√£o
            const fmt = (v) => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            if (type === 'cashflow') {
                // Soma total de receitas e despesas (de todo o hist√≥rico)
                const receitas = transactions.filter(t => t.tipo === 'receita').reduce((acc, t) => acc + Number(t.valor), 0);
                const despesas = transactions.filter(t => t.tipo === 'despesa').reduce((acc, t) => acc + Number(t.valor), 0);
                const saldo = receitas - despesas;
                
                content = `
                    <div class="report-summary-box">
                        <div class="summary-item">
                            <div class="summary-label">Receitas</div>
                            <div class="summary-val text-green">${fmt(receitas)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Despesas</div>
                            <div class="summary-val text-red">${fmt(despesas)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Saldo</div>
                            <div class="summary-val" style="color: ${saldo >= 0 ? 'black' : 'red'}">${fmt(saldo)}</div>
                        </div>
                    </div>
                    <p>Total de transa√ß√µes registradas: <strong>${transactions.length}</strong></p>
                `;

            } else if (type === 'doctors') {
                // Agrupa receitas por m√©dico
                const doctorTotals = {};
                transactions.filter(t => t.tipo === 'receita' && t.medico).forEach(t => {
                    doctorTotals[t.medico] = (doctorTotals[t.medico] || 0) + Number(t.valor);
                });
                
                // Ordena do maior para o menor
                const sorted = Object.entries(doctorTotals).sort((a, b) => b[1] - a[1]);
                
                if(sorted.length > 0) {
                    content = '<ul class="report-list">';
                    sorted.forEach(([doc, val]) => {
                        content += `<li><span>${doc}</span> <strong>${fmt(val)}</strong></li>`;
                    });
                    content += '</ul>';
                } else {
                    content = '<p>Nenhuma receita associada a m√©dicos encontrada.</p>';
                }

            } else if (type === 'receivables') {
                // Filtra receitas n√£o pagas
                const pending = transactions.filter(t => t.tipo === 'receita' && t.status !== 'pago');
                const total = pending.reduce((acc, t) => acc + Number(t.valor), 0);

                content = `<p><strong>Total a Receber: ${fmt(total)}</strong></p>`;
                if (pending.length > 0) {
                    content += '<ul class="report-list">';
                    pending.forEach(t => {
                        content += `<li><span>${formatDate(t.data)} - ${t.entity} (${t.desc})</span> <span style="color:orange;">${fmt(t.valor)}</span></li>`;
                    });
                    content += '</ul>';
                } else {
                    content += '<p>N√£o h√° contas pendentes.</p>';
                }

            } else if (type === 'expenses') {
                // Agrupa despesas por categoria
                const catTotals = {};
                transactions.filter(t => t.tipo === 'despesa').forEach(t => {
                    catTotals[t.categoria] = (catTotals[t.categoria] || 0) + Number(t.valor);
                });
                
                if (Object.keys(catTotals).length > 0) {
                    content = '<ul class="report-list">';
                    Object.entries(catTotals).forEach(([cat, val]) => {
                        content += `<li><span>${cat}</span> <strong class="text-red">${fmt(val)}</strong></li>`;
                    });
                    content += '</ul>';
                } else {
                    content = '<p>Nenhuma despesa registrada.</p>';
                }
            }

            document.getElementById('reportTitleDynamic').innerText = reportTitles[type];
            document.getElementById('reportContent').innerHTML = content;
            document.getElementById('reportModal').style.display = 'flex';
        }

        function openDetailedReport() {
            generateReport('cashflow'); // Usa o fluxo de caixa como relat√≥rio detalhado padr√£o
        }

        function exportData(format) {
            if (format === 'csv' || format === 'excel') {
                let csv = "ID,Data,Descri√ß√£o,Entidade,M√©dico,Valor,Tipo,Status\n";
                const list = getTransactions();
                list.forEach(t => {
                    csv += `${t.id},${t.data},"${t.desc}","${t.entity}","${t.medico}",${t.valor},${t.tipo},${t.status}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `financeiro_cherryhp.csv`;
                a.click();
            } else {
                window.print();
            }
        }
        
        function showNotification(message, type) {
            console.log(message);
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        function formatDate(dateStr) {
            if(!dateStr) return '-';
            const parts = dateStr.split('-');
            if(parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
            return dateStr;
        }
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>