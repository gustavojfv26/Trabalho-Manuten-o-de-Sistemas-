<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacientes - Cl√≠nica M√©dica</title>
    <link rel="stylesheet" href="../estilo.css">
    <style>
        /* Novos estilos para a tela de pacientes */
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filters-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .loyalty-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .loyalty-bronze {
            background-color: #cd7f32;
            color: white;
        }
        
        .loyalty-silver {
            background-color: #c0c0c0;
            color: #333;
        }
        
        .loyalty-gold {
            background-color: #ffd700;
            color: #333;
        }
        
        .loyalty-platinum {
            background: linear-gradient(45deg, #e5e4e2, #cfc9c2);
            color: #333;
        }
        
        .patient-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .patient-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .loyalty-benefits {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .loyalty-benefits h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .benefits-list {
            list-style-type: none;
        }
        
        .benefits-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
        }
        
        .benefits-list li:before {
            content: "‚úì";
            margin-right: 10px;
            color: #2ecc71;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .filters-container {
                flex-direction: column;
            }
            
            .patient-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>CherryHP</h2>
            </div>
            
            <div class="sidebar-menu">
                <div onclick="window.location.href = 'index.html'" class="menu-item" data-page="dashboard">
                    <span>üè†</span> Dashboard
                </div>
                <div onclick="window.location.href = 'pacientes.html'" class="menu-item active" data-page="pacientes">
                    <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Pacientes
                </div>
                <div onclick="window.location.href = 'consultas.html'" class="menu-item" data-page="consultas">
                    <span>üìÖ</span> Consultas
                </div>
                <div onclick="window.location.href = 'medicos.html'" class="menu-item" data-page="medicos">
                    <span>üë®‚Äç‚öïÔ∏è</span> M√©dicos
                </div>
                <div onclick="window.location.href = 'prontuarios.html'" class="menu-item" data-page="prontuarios">
                    <span>üìã</span> Prontu√°rios
                </div>
                <div onclick="window.location.href = 'financeiro.html'" class="menu-item" data-page="financeiro">
                    <span>üí∞</span> Financeiro
                </div>
                <div onclick="window.location.href = 'configuracoes.html'" class="menu-item" data-page="configuracoes">
                    <span>‚öôÔ∏è</span> Configura√ß√µes
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1>Pacientes</h1>
                <div class="user-info">
                    <div class="user-avatar">AD</div>
                    <span>Admin</span>
                    <button class="logout-btn">Sair</button>
                </div>
            </div>
            
            <div class="patient-header">
                <h2>Gerenciamento de Pacientes</h2>
                <button onclick="window.location.href = '../cadastro/paciente.html'" class="btn btn-primary">Novo Paciente</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div>Total de Pacientes</div>
                    <div class="stat-value" id="totalPatientsCount">0</div>
                </div>
                <div class="stat-item">
                    <div>Novos este m√™s</div>
                    <div class="stat-value">42</div>
                </div>
                <div class="stat-item">
                    <div>Programa Fidelidade</div>
                    <div class="stat-value">893</div>
                </div>
                <div class="stat-item">
                    <div>Em dia com pagamentos</div>
                    <div class="stat-value">1,103</div>
                </div>
            </div>
            
            <div class="filters-container">
                <div class="filter-group">
                    <label for="searchInput">Buscar paciente</label>
                    <input type="text" id="searchInput" placeholder="Nome, CPF ou telefone...">
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="">Todos</option>
                        <option value="active">Ativo</option>
                        <option value="inactive">Inativo</option>
                        <option value="overdue">Com pend√™ncias</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="loyaltyFilter">Categoria Fidelidade</label>
                    <select id="loyaltyFilter">
                        <option value="">Todas</option>
                        <option value="bronze">Bronze</option>
                        <option value="silver">Prata</option>
                        <option value="gold">Ouro</option>
                        <option value="platinum">Platina</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="bloodTypeFilter">Tipo Sangu√≠neo</label>
                    <select id="bloodTypeFilter">
                        <option value="">Todos</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn" id="applyFilters">Aplicar Filtros</button>
                </div>
            </div>
            
            <div class="export-options">
                <button class="btn" onclick="exportToExcel()">
                    üìä Exportar para Excel
                </button>
                <button class="btn" onclick="exportToPDF()">
                    üìÑ Exportar para PDF
                </button>
                <button class="btn" onclick="generateLoyaltyReport()">
                    üëë Relat√≥rio de Fidelidade
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Lista de Pacientes</h3>
                    <div class="search-box">
                        <input type="text" placeholder="Buscar paciente..." id="searchTable">
                        <button class="btn" id="searchButton">Buscar</button>
                    </div>
                </div>
                
                <table class="table" id="patientsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Data Nasc.</th>
                            <th>Telefone</th>
                            <th>Categoria</th>
                            <th>√öltima Consulta</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="patientsTableBody">
                        </tbody>
                </table>

                <div class="pagination">
                    <button class="btn" id="prevPage">Anterior</button>
                    <span id="pageInfo">P√°gina 1 de 1</span>
                    <button class="btn" id="nextPage">Pr√≥xima</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="patient-details-modal" id="patientDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes do Paciente</h3>
                <button class="btn btn-danger" onclick="closeModal()">Fechar</button>
            </div>
            <div id="patientDetailsContent">
                </div>
        </div>
    </div>

    <div class="patient-details-modal" id="patientHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Hist√≥rico do Paciente</h3>
                <button class="btn btn-danger" onclick="closeHistoryModal()">Fechar</button>
            </div>
            <div id="patientHistoryContent">
                </div>
        </div>
    </div>
    
    <script src="../script.js"></script>
    <script>
        // --- GERENCIAMENTO DE DADOS (LOCALSTORAGE) ---
        const STORAGE_KEY = 'cherryhp_pacientes';

        // Dados iniciais para popular o sistema na primeira vez
        const initialData = [
            { id: 1001, nome: 'Jo√£o Silva', cpf: '123.456.789-00', data_nasc: '1985-03-15', telefone: '(11) 9999-8888', categoria: 'Platina', ultima_consulta: '10/05/2023', status: 'active', tipo_sanguineo: 'A+', totalSpent: 12500, consultas: 28 },
            { id: 1002, nome: 'Maria Oliveira', cpf: '987.654.321-00', data_nasc: '1990-07-22', telefone: '(11) 9888-7777', categoria: 'Ouro', ultima_consulta: '08/05/2023', status: 'active', tipo_sanguineo: 'O+', totalSpent: 7800, consultas: 15 },
            { id: 1003, nome: 'Pedro Santos', cpf: '456.789.123-00', data_nasc: '1978-11-10', telefone: '(11) 9777-6666', categoria: 'Prata', ultima_consulta: '05/05/2023', status: 'overdue', tipo_sanguineo: 'B-', totalSpent: 3500, consultas: 8 },
            { id: 1004, nome: 'Ana Costa', cpf: '321.654.987-00', data_nasc: '2000-01-30', telefone: '(11) 9666-5555', categoria: 'Bronze', ultima_consulta: '02/05/2023', status: 'inactive', tipo_sanguineo: 'AB+', totalSpent: 800, consultas: 3 }
        ];

        function getPatients() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(initialData));
                return initialData;
            }
            return JSON.parse(data);
        }

        function savePatients(patients) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(patients));
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            // Se j√° estiver no formato BR
            if (dateString.includes('/')) return dateString;
            // Converte yyyy-mm-dd para dd/mm/yyyy
            const parts = dateString.split('-');
            if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
            return dateString;
        }

        function getLoyaltyClass(category) {
            const map = {
                'Platina': 'loyalty-platinum',
                'Ouro': 'loyalty-gold',
                'Prata': 'loyalty-silver',
                'Bronze': 'loyalty-bronze',
                'Iniciante': 'loyalty-bronze'
            };
            return map[category] || 'loyalty-bronze';
        }

        // --- RENDERIZA√á√ÉO E L√ìGICA DE TELA ---
        
        let currentPage = 1;
        const rowsPerPage = 10;

        document.addEventListener('DOMContentLoaded', function() {
            renderTable(); // Carrega os dados do storage para a tabela

            // Configura√ß√£o dos bot√µes de pagina√ß√£o
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    filterPatients();
                }
            });
            document.getElementById('nextPage').addEventListener('click', () => {
                currentPage++; // A verifica√ß√£o de limite m√°ximo √© feita dentro de filterPatients
                filterPatients();
            });

            // Configura√ß√£o dos filtros
            setupFilters();
        });

        function renderTable() {
            const patients = getPatients();
            const tbody = document.getElementById('patientsTableBody');
            tbody.innerHTML = '';
            
            // Atualiza contador total
            document.getElementById('totalPatientsCount').innerText = patients.length;

            patients.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'patient-row';
                
                // Adiciona atributos de dados para os filtros funcionarem
                tr.setAttribute('data-status', p.status || 'active');
                tr.setAttribute('data-loyalty', getLoyaltyClass(p.categoria).replace('loyalty-', ''));
                tr.setAttribute('data-blood-type', p.tipo_sanguineo || '');

                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.nome} 
                        <span class="loyalty-badge ${getLoyaltyClass(p.categoria)}">${p.categoria}</span>
                    </td>
                    <td>${p.cpf}</td>
                    <td>${formatDate(p.data_nasc)}</td>
                    <td>${p.telefone}</td>
                    <td>${p.categoria}</td>
                    <td>${p.ultima_consulta || '-'}</td>
                    <td class="patient-actions">
                        <button class="btn btn-primary btn-sm" onclick="showPatientDetails(${p.id})">Ver</button>
                        <button class="btn btn-primary btn-sm" onclick="editPatient(${p.id})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePatient(${p.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Aplica pagina√ß√£o inicial
            filterPatients();
        }

        function setupFilters() {
            const applyFiltersBtn = document.getElementById('applyFilters');
            const searchInput = document.getElementById('searchInput');
            const searchTable = document.getElementById('searchTable');
            const searchButton = document.getElementById('searchButton');

            // Sincroniza inputs de busca
            searchTable.addEventListener('input', function() {
                searchInput.value = this.value; 
                filterPatients();
            });
            searchInput.addEventListener('input', function() {
               searchTable.value = this.value; 
            });

            // Bot√µes de filtro
            applyFiltersBtn.addEventListener('click', function() {
                filterPatients();
                showNotification('Filtros aplicados com sucesso!', 'success');
            });
            searchButton.addEventListener('click', function() {
                filterPatients();
            });
        }

        function filterPatients() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const statusValue = document.getElementById('statusFilter').value;
            const loyaltyValue = document.getElementById('loyaltyFilter').value;
            const bloodTypeValue = document.getElementById('bloodTypeFilter').value;
            
            const rows = document.querySelectorAll('.patient-row');
            let matches = [];
            
            rows.forEach(row => {
                const name = row.cells[1].innerText.toLowerCase();
                const cpf = row.cells[2].innerText;
                const phone = row.cells[4].innerText;
                
                const rowStatus = row.getAttribute('data-status');
                const rowLoyalty = row.getAttribute('data-loyalty'); 
                const rowBloodType = row.getAttribute('data-blood-type');
                
                const matchesSearch = name.includes(searchValue) || cpf.includes(searchValue) || phone.includes(searchValue);
                const matchesStatus = !statusValue || rowStatus === statusValue;
            
                const matchesLoyalty = !loyaltyValue || rowLoyalty === loyaltyValue;
                const matchesBloodType = !bloodTypeValue || rowBloodType === bloodTypeValue;
                
                if (matchesSearch && matchesStatus && matchesLoyalty && matchesBloodType) {
                    matches.push(row);
                } else {
                    row.style.display = 'none';
                }
            });

            // Pagina√ß√£o
            const totalMatches = matches.length;
            const totalPages = Math.ceil(totalMatches / rowsPerPage) || 1;
            
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            document.getElementById('pageInfo').innerText = `P√°gina ${currentPage} de ${totalPages}`;
            
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            
            matches.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = ''; // Mostra (tabela default)
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        // --- A√á√ïES DO USU√ÅRIO ---

        function deletePatient(id) {
            if (confirm('Tem certeza que deseja excluir este paciente permanentemente?')) {
                let patients = getPatients();
                // Filtra removendo o ID selecionado
                // Usamos != frouxo pois o ID no HTML pode ser string e no JSON number
                const newPatients = patients.filter(p => p.id != id);
                
                savePatients(newPatients);
                renderTable(); // Recarrega a tabela com os novos dados
                
                showNotification(`Paciente ${id} exclu√≠do com sucesso.`, 'success');
            }
        }

        function editPatient(id) {
            // Redireciona para a p√°gina de edi√ß√£o passando o ID
            window.location.href = `../cadastro/paciente.html?id=${id}&edit=true`;
        }

        function showPatientDetails(id) {
            const patients = getPatients();
            const patient = patients.find(p => p.id == id);
            
            if(!patient) return;

            const modal = document.getElementById('patientDetailsModal');
            const content = document.getElementById('patientDetailsContent');
            
            // Simula√ß√£o de benef√≠cios baseada na categoria
            const benefits = getLoyaltyBenefits(patient.categoria);

            content.innerHTML = `
                <h4>${patient.nome} - <span class="loyalty-badge ${getLoyaltyClass(patient.categoria)}">${patient.categoria}</span></h4>
                <p><strong>CPF:</strong> ${patient.cpf}</p>
                <p><strong>Email:</strong> ${patient.email || '-'}</p>
                <p><strong>Total gasto:</strong> R$ ${(patient.totalSpent || 0).toLocaleString('pt-BR')}</p>
                <p><strong>N√∫mero de consultas:</strong> ${patient.consultations || 0}</p>
                
                <div class="loyalty-benefits">
                    <h4>Benef√≠cios da Categoria ${patient.categoria}</h4>
                    <ul class="benefits-list">
                        ${benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="upgradeLoyalty(${patient.id})">Solicitar Upgrade</button>
                    <button class="btn" onclick="showPatientHistory(${patient.id})">Ver Hist√≥rico</button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Fun√ß√µes auxiliares mantidas (Fidelidade, Exporta√ß√£o, Modais)
        
        function getLoyaltyBenefits(category) {
            const benefits = {
                'Platina': ['Desconto de 20%', 'Atendimento priorit√°rio', 'Telemedicina gratuita'],
                'Ouro': ['Desconto de 15%', 'Atendimento priorit√°rio', 'Reagendamento gr√°tis'],
                'Prata': ['Desconto de 10%', 'Lembretes via WhatsApp'],
                'Bronze': ['Desconto de 5% na 2¬™ consulta'],
                'Iniciante': ['Boas-vindas ao programa']
            };
            return benefits[category] || benefits['Iniciante'];
        }

        function closeModal() {
            document.getElementById('patientDetailsModal').style.display = 'none';
        }
        
        function closeHistoryModal() {
            document.getElementById('patientHistoryModal').style.display = 'none';
        }

        function showPatientHistory(id) {
            document.getElementById('patientDetailsModal').style.display = 'none';
            const modal = document.getElementById('patientHistoryModal');
            const content = document.getElementById('patientHistoryContent');
            
            // Conte√∫do est√°tico de exemplo para o hist√≥rico
            content.innerHTML = `<p>Hist√≥rico simulado para paciente #${id}. (Implementa√ß√£o real requereria tabela de hist√≥rico)</p>`;
            modal.style.display = 'flex';
        }

        function upgradeLoyalty(id) {
            let patients = getPatients();
            let pIndex = patients.findIndex(p => p.id == id);
            
            if (pIndex !== -1) {
                const cats = ['Iniciante', 'Bronze', 'Prata', 'Ouro', 'Platina'];
                let currentCat = patients[pIndex].categoria || 'Iniciante';
                let idx = cats.indexOf(currentCat);
                
                if (idx < cats.length - 1) {
                    patients[pIndex].categoria = cats[idx + 1];
                    savePatients(patients);
                    renderTable();
                    closeModal();
                    showNotification(`Upgrade realizado para ${cats[idx + 1]}!`, 'success');
                } else {
                    showNotification('Paciente j√° est√° no n√≠vel m√°ximo!', 'info');
                }
            }
        }

        function showNotification(message, type) {
            alert(`${type.toUpperCase()}: ${message}`);
        }

        function exportToExcel() {
            alert("Fun√ß√£o de exportar Excel (Simula√ß√£o)");
        }

        function exportToPDF() {
            window.print();
        }
        
        function generateLoyaltyReport() {
            const patients = getPatients();
            let counts = { 'Platina': 0, 'Ouro': 0, 'Prata': 0, 'Bronze': 0, 'Iniciante': 0 };
            
            patients.forEach(p => {
                let cat = p.categoria || 'Iniciante';
                if (counts[cat] !== undefined) counts[cat]++;
            });
            
            alert(`Relat√≥rio:\nPlatina: ${counts.Platina}\nOuro: ${counts.Ouro}\nPrata: ${counts.Prata}\nBronze: ${counts.Bronze}`);
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('patientDetailsModal');
            if (event.target === modal) closeModal();
        });
    </script>
</body>
</html>